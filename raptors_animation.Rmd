---
title: "Raptors baskets"
output: html_document
---

```{r packages, message = FALSE}
library(tidyverse) # tidyverse
library(gganimate) # for animating the chart
library(ggimage) # for inserting the basketballs
library(rvest) # for scraping websites
library(lubridate) # for date manipulation
library(ggrepel) 
library(png) 
library(grid)
library(extrafont)
library(ggtext)
loadfonts(device = "pdf", quiet = TRUE)
theme_set(theme_light(base_size = 20, base_family = "Roboto Condensed"))
```

```{r scrape_data}
page_url <- "https://www.basketball-reference.com/boxscores/pbp/201912140TOR.html"

event_info <- read_html(page_url) %>%
  html_table()
```

```{r clean_data}
opponent <- "Brooklyn Nets"
game_data <- as.data.frame(event_info)[-1,]

# Check if toronto is the home team
if (str_detect(page_url, "(TOR)") == TRUE){
  names(game_data) <- c("time", "opponent_action", "opponent_point_increase", "running_score", "toronto_point_increase", "toronto_action")
} else {
  names(game_data) <- c("time", "toronto_action", "toronto_point_increase", "running_score", "opponent_point_increase", "opponent_action")
}

# clean up the data
scoring_plays <- game_data %>%
  mutate(toronto_point_increase = str_extract(toronto_point_increase, "[0-9]"),
         opponent_point_increase = str_extract(opponent_point_increase, "[0-9]"),
         shot_type = case_when(
           toronto_point_increase == 1 | opponent_point_increase == 1 ~ "free-throw",
           toronto_point_increase == 2 | opponent_point_increase == 2 ~ "2-pointer",
           toronto_point_increase == 3 | opponent_point_increase == 3 ~ "3-pointer"
         )) %>%
  filter(!is.na(toronto_point_increase) | !is.na(opponent_point_increase),
         str_detect(running_score, "[0-9]+-[0-9]+"))

scoring_df <- scoring_plays %>%
  mutate(scoring_player = str_extract(toronto_action, "[A-Z]\\. [A-Za-z-]+"),
         scoring_play = str_extract(opponent_action, "[A-Z]\\. [A-Za-z-]+")) %>%
  mutate(scoring_player = str_remove(paste0(scoring_player, scoring_play), "(NA)"),
         points = str_extract(paste0(toronto_point_increase, opponent_point_increase), "[0-9]"),
         team = ifelse(str_detect(toronto_action, "[a-z]"), "Toronto Raptors", opponent)) %>%
  select(shot_type, scoring_player, points, team, running_score) 
```

```{r}
# labels <- scoring_df %>%
#   group_by(scoring_player) %>%
#   summarize(total_points = sum(as.numeric(points))) %>%
#   mutate(label = str_glue("{scoring_player} ({total_points})"))

# make the game start at 00-00
start_of_game <- data.frame(running_score = "00-00") 

cleaned_df <- start_of_game %>%
  bind_rows(scoring_df) %>%
  mutate(action_order = row_number()) %>%
  group_by(team, scoring_player) %>%
  mutate(player_order = row_number()) %>%
  ungroup() 

if (str_detect(page_url, "(TOR)") == TRUE){
  cleaned_df <- cleaned_df %>%  
    mutate(toronto_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$") )),
           away_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+") )),
           running_score = str_glue("{toronto_score}-{away_score}"),
           points = as.numeric(points))
} else {
  cleaned_df <- cleaned_df %>%  
    mutate(toronto_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+") )),
           away_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$") )),
           running_score = str_glue("{toronto_score}-{away_score}"),
           points = as.numeric(points))
}

cleaned_df <- cleaned_df %>%  
  mutate(toronto_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+") )),
         away_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$") )),
         running_score = str_glue("{toronto_score}-{away_score}"),
         points = as.numeric(points))

animation_df <- cleaned_df %>%
  mutate(running_score = factor(running_score, 
                                levels = .$running_score,
                                ordered = TRUE),
         scoring_player = str_wrap(scoring_player, 2))
```

```{r}
l <- readPNG("~/Downloads/toronto_raptors_logo.png")
f <- matrix(rgb(l[,,1],l[,,2],l[,,3], l[,,4] * 0.2), nrow=dim(l)[1]) #0.2 is alpha
raptors_logo <- rasterGrob(f, interpolate=TRUE)
```

```{r, warning = FALSE}
# Raptors Only
x_axis <- animation_df %>% 
  filter(team == "Toronto Raptors") %>% 
  distinct(scoring_player)

base_plot <- animation_df %>%
  ggplot(aes(x = scoring_player, y = player_order, group = action_order)) +
  annotation_custom(raptors_logo, 
                    xmin = -Inf, xmax = Inf, 
                    ymin = -Inf, ymax = Inf)+
  geom_image(aes(image = "~/Downloads/basketball.png"), size = 0.06) +
  scale_x_discrete(limits = x_axis$scoring_player, 
                   labels = str_wrap(x_axis$scoring_player, 2)) +
  labs(title = "<b style='color:#BA0C2F'>Toronto Raptors</b> {closest_state} <b style='color:#000000'>Brooklyn Nets</b>",
       x = "",
       y = "Baskets") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_markdown(size = 45, face = "bold", colour = "#000000",
                                      lineheight = 1, vjust = -1, hjust = 0.56)) 
  # geom_image(data = team_animation_df %>% filter(points == 3), 
  #            aes(image = "~/Downloads/basketball_red.png"), size = 0.075, asp = 0.5) +
  # geom_image(data = team_animation_df %>% filter(points == 1), 
  #            aes(image = "~/Downloads/basketball copy.png"), size = 0.06, asp = 0.5, ) +
  # geom_image(data = team_animation_df %>% filter(points == 2), 
  #            aes(image = "~/Downloads/basketball.png"), size = 0.07, asp = 0.5) 
```

```{r}
# Both Teams

w <- readPNG("~/Downloads/400px-Philadelphia_76ers_logo.svg.png")
g <- matrix(rgb(w[,,1],w[,,2],w[,,3], w[,,4] * 0.2), nrow=dim(w)[1]) #0.2 is alpha
opponent_logo <- rasterGrob(g, interpolate=TRUE)

team_animation_df <- animation_df %>%
  filter(!is.na(team)) %>%
  mutate(team = factor(team, levels = c("Toronto Raptors", "Brooklyn Nets")))

annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data){
  layer(data = data,
        stat = StatIdentity,
        position = PositionIdentity,
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE,
        params = list(grob = grob, xmin = xmin, xmax = xmax,ymin = ymin, ymax = ymax))
}

team_plot <- team_animation_df %>%
  ggplot(aes(x = scoring_player, y = player_order, group = action_order)) +
  geom_image(aes(image = "~/Downloads/basketball.png")) +
  ggthemes::scale_fill_tableau(name = NULL) +
  facet_wrap(~team, scales = "free_x", nrow = 2) +
  labs(title = "[{closest_state}]",
       x = "",
       y = "Baskets") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(color="black", fill = "#A1A1A4", size = 1.5, linetype = "solid"),
        plot.title = element_markdown(size = 35, face = "bold", colour = "#000000",
                                      lineheight = 1, vjust = -1, hjust = 0.5),
        strip.text = element_markdown(size = 11))

team_plot <- team_plot +
  annotation_custom2(raptors_logo, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf, data = team_animation_df[1,]) +
  annotation_custom2(opponent_logo, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf, data = team_animation_df[2,])
```

```{r}
animate_plot <- function(plot_type = base_plot){
  plot_type +
    transition_states(running_score, transition_length = 0.5, state_length = 0.1, wrap = FALSE) +
    enter_fly(y_loc = 16) +
    ease_aes(y = "bounce-out") + 
    shadow_mark()
}

anim <- animate_plot(base_plot)
```

```{r}
anim_save(str_glue("animations/raptors_{opponent}-{str_extract(page_url, '[0-9]+')}.gif"), anim, fps = 25, duration = nrow(animation_df)/3.5, type = "cairo-png", width = 1024, height = 512, renderer = gifski_renderer(loop = FALSE))

beepr::beep()
```

