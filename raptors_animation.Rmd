---
title: "NBA animated baskets"
output: html_document
---

# Setup

```{r packages, message = FALSE}
library(tidyverse) # for the basics
library(gganimate) # for animation and gifs
library(ggimage) # for inserting the basketball emojis
library(rvest) # for scraping data from websites
library(lubridate) # for date manipulation
library(png) # for image manipulation
library(grid) # for custom plot manipulation
library(ggtext) # for colouring the plot title
library(extrafont) # for nicer fonts
loadfonts(device = "pdf", quiet = TRUE)
theme_set(theme_light(base_size = 20, base_family = "Roboto Condensed"))
```

# Input

```{r page_link}
page_url <- "https://www.basketball-reference.com/boxscores/pbp/202001080CHO.html"

team_of_interest <- "Toronto Raptors"
```

# Scraping

```{r play_by_play_data}
# read play-by-play url, check robots.txt if allowed
if (robotstxt::paths_allowed(page_url)){
  web_page_data <- read_html(page_url)
}

# scrape the url for tables
event_info <- web_page_data %>%
  html_table()

# extract play-by-play table
game_data <- as.data.frame(event_info)[-1,]

names(game_data) <- c("time", "away_action", "away_point_increase", 
                      "running_score", "home_point_increase", "home_action")
```

```{r team_data}
team_id_data <- web_page_data %>%
  html_nodes("body") %>%
  html_nodes("strong") %>%
  html_text() %>%
  str_trim()

away_team <- team_id_data[2]
home_team <- team_id_data[3]

final_score_data <- web_page_data %>%
  html_nodes("body") %>%
  html_nodes("div.score") %>%
  html_text() 

final_away_score <- as.numeric(final_score_data[1])
final_home_score <- as.numeric(final_score_data[2])

box_score <- data.frame(team = c(home_team, away_team),
                        final_score = as.numeric(c(final_home_score, final_away_score)))

winner <- box_score %>% filter(final_score == max(.$final_score)) %>% .$team %>% as.character()
loser <- box_score %>% filter(final_score == min(.$final_score)) %>% .$team %>% as.character()
opponent <- ifelse(home_team == team_of_interest, away_team, home_team)
```

# Cleaning

```{r scoring_plays}
# extract only the scoring plays
scoring_plays <- game_data %>%
  mutate(home_point_increase = str_extract(home_point_increase, "[0-9]"),
         away_point_increase = str_extract(away_point_increase, "[0-9]")) %>%
  filter(!is.na(home_point_increase) | !is.na(away_point_increase),
         str_detect(running_score, "[0-9]+-[0-9]+"))
```

```{r player_names}
# extract player name from action data 
scoring_df <- scoring_plays %>%
  mutate(scoring_home_player = str_extract(home_action, "[A-Z]\\. [A-Za-z-]+"),
         scoring_away_player = str_extract(away_action, "[A-Z]\\. [A-Za-z-]+"),
         scoring_player = paste0(scoring_home_player, scoring_away_player),
         scoring_player = str_remove(scoring_player, "(NA)"),
         points = as.numeric(str_extract(paste0(home_point_increase, away_point_increase), "[0-9]")),
         team = ifelse(str_detect(home_action, "[a-z]"), home_team, away_team),
         time = str_remove(time, "\\.0")) %>%
  select(time, scoring_player, points, team, running_score) 
```

# Cumulating points

```{r}
full_scoring_df <- scoring_df %>%
  group_by(scoring_player) %>%
  mutate(running_point_total = cumsum(points))
```


# Sequencing

```{r}
# make the game start at 00-00
start_of_game <- data.frame(running_score = "00-00", time = "12:00") 
end_of_game <- data.frame(running_score = tail(scoring_df$running_score, 1), time = "Final")

# builds the game's scoring plays and orders them
game_sequence_df <- start_of_game %>%
  bind_rows(full_scoring_df) %>%
  bind_rows(end_of_game) %>%
  mutate(action_order = row_number()) %>% # frames for the animation
  group_by(team, scoring_player) %>%
  mutate(player_baskets = row_number()) %>% # player basket counts
  ungroup() 
```


# Building winner on left side

```{r}
# winning team is on the left side of the title
if (home_team == team_of_interest){
  final_game_sequence_df <- game_sequence_df %>%  
    mutate(team_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$"))),
           opponent_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+"))),
           running_score = str_glue("{team_score}-{opponent_score}"),
           running_score = paste0("<span style='font-size:45pt'>", running_score, "</span>", "<br>", 
                                  "<span style='font-size:20pt'>", time, "</span>"))
} else {
  final_game_sequence_df <- game_sequence_df %>%  
    mutate(team_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+"))),
           opponent_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$"))),
           running_score = str_glue("{team_score}-{opponent_score}"),
           running_score = paste0("<span style='font-size:40pt'>", running_score, "</span>", "<br>", 
                                  "<span style='font-size:25pt'>", time, "</span>"))
}
```

```{r}
# gotta turn this into a factor so I can use {current_frame} to track boxscore
animation_df <- final_game_sequence_df %>%
  mutate(running_score = factor(running_score, 
                                levels = .$running_score,
                                ordered = TRUE))
```

# Getting image

```{r}
# lookup the team image files
files <- file.info(list.files(str_glue("{here::here()}/team_images"), 
                              full.names = TRUE))

image_paths <- data.frame(path = rownames(files))

# look for the winner's image 
winner_path <- image_paths %>%
  mutate_if(is.factor, as.character) %>%
  filter(str_detect(path, str_extract(winner, "[a-zA-Z]+$"))) %>%
  .$path

# winner logo
m <- readPNG(winner_path)

# makes it transparent - 0.2 is alpha
w <- matrix(rgb(m[,,1],m[,,2],m[,,3], m[,,4] * 0.2), nrow=dim(m)[1])

winner_logo <- rasterGrob(w, interpolate=TRUE)
```

# Colours for title from https://teamcolorcodes.com/nba-team-color-codes/

```{r team_colour}
# obtain the winning team's colour from https://teamcolorcodes.com/nba-team-color-codes/
team_url <- paste0("https://teamcolorcodes.com/",  tolower(str_replace_all(team_of_interest, " ", "-")), "-color-codes/")

if (robotstxt::paths_allowed(team_url)) {
event_info <- read_html(team_url) %>%
  html_nodes("body") %>%
  html_nodes("div") %>%
  html_text()
}

team_colour <- str_extract(event_info[9], "#[a-zA-Z0-9]+")
```

```{r opponent_colour}
# obtain the losing team's colour from https://teamcolorcodes.com/nba-team-color-codes/
opponent_url <- paste0("https://teamcolorcodes.com/",  tolower(str_replace_all(opponent, " ", "-")), "-color-codes/")

if (robotstxt::paths_allowed(opponent_url)){
event_info <- read_html(opponent_url) %>%
  html_nodes("body") %>%
  html_nodes("div") %>%
  html_text()
}

opponent_colour <- str_extract(event_info[9], "#[a-zA-Z0-9]+")
```

# Base Plot

```{r plot_breaks}
# winning team players only on the x-axis
x_axis <- animation_df %>% 
  filter(team == team_of_interest) %>% 
  distinct(scoring_player)
```

```{r}
# upper limit
upper_y_limit <- max(animation_df %>% 
      filter(team == team_of_interest) %>% 
      select(player_baskets)) + 1
```


```{r}
# scores on final frame
final_frame_scores <- animation_df %>% 
  group_by(scoring_player) %>% 
  filter(running_point_total == max(running_point_total)) %>% 
  ungroup() %>% 
  mutate(running_score = tail(.$running_score, 1))
```

```{r}
if (nchar(team_of_interest) < nchar(opponent_url)){
  white_space_needed <- c(rep("a", times = nchar(opponent) - nchar(team_of_interest))) %>%
    str_flatten()
  
  centred_title <- paste0("<b style='color:#ffffff'>", white_space_needed, "</b>", "<b style='color:", team_colour, "'>", winner, "</b>", " vs. ", "<b style='color:", opponent_colour, "'>", opponent, "</b>")
  
} else {
  white_space_needed <- c(rep("a", times = nchar(team_of_interest) - nchar(opponent))) %>%
    str_flatten()
  
  centred_title <- paste0("<b style='color:", team_colour, "'>", team_of_interest, "</b>", " vs. ", "<b style='color:", opponent_colour, "'>", opponent, "</b>", "<b style='color:#ffffff>", white_space_needed, "</b>")
}
```

```{r, warning = FALSE, dev = "CairoPNG", fig.width = 960, fig.height= 540, dpi = 300}
(base_plot <- animation_df %>%
   ggplot(aes(x = scoring_player, y = player_baskets, group = action_order)) +
   annotation_custom(winner_logo, 
                     xmin = -Inf, xmax = Inf, 
                     ymin = -Inf, ymax = Inf) +
   geom_image(aes(image = str_glue("{here::here()}/emoji/basketball.png")), size = 0.075) +
   geom_image(data = animation_df %>% filter(points == 3), 
              aes(image = str_glue("~/Downloads/flame_ring_copy.png")), size = 0.075) +
   # geom_text(data = animation_df %>% filter(points == 1), aes(label = "â€”"), size = 13, colour = "black", alpha = 0.5, nudge_y = 0.05) +
   geom_text(data = final_frame_scores, aes(label = running_point_total), size = 8, face = "bold", nudge_y = 1.5) +
   scale_x_discrete("",
                    limits = x_axis$scoring_player, 
                    labels = str_wrap(x_axis$scoring_player, 2)) +
   scale_y_continuous("Baskets",
                      breaks = seq(0, 25, by = 5)) + 
   labs(title = centred_title,
        subtitle = "{closest_state}") +
   theme(panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         plot.title = element_markdown(size = 40, face = "bold", colour = "#000000",
                                       lineheight = 1, vjust = -1, hjust = 0.5),
         plot.subtitle = element_markdown(face = "bold", hjust = 0.5)) +
   expand_limits(y = upper_y_limit))
```

```{r, dpi = 300,}
animated_plot <- base_plot +
  transition_states(running_score, transition_length = 0.8, state_length = 0.2, wrap = FALSE) +
  enter_fly(y_loc = max(animation_df$player_baskets) + 2) +
  ease_aes(y = "bounce-out") + 
  shadow_mark()
```

# Saving

```{r, dpi = 300}
game_date <- str_remove(str_extract(page_url, '[0-9]+'), "0$")

anim_save(animate(animated_plot,
          width = 960, height = 540,
          fps = 30, 
          duration = round(nrow(animation_df)/3), 
          end_pause = 150), filename = str_glue("animations/{team_of_interest}_{opponent}-{game_date}.gif"))

beepr::beep()
```

