---
title: "Raptors baskets"
output: html_document
---

# Setup

```{r packages, message = FALSE}
library(tidyverse) # tidyverse
library(gganimate) # for animating the chart
library(ggimage) # for inserting the basketballs
library(rvest) # for scraping websites
library(lubridate) # for date manipulation
library(extrafont) # for nice text
library(ggtext) # for rendering colour text
library(ggrepel) 
library(png)  # for loading the raptors logo
library(grid) # for custom ggplot modification
loadfonts(device = "pdf", quiet = TRUE)
theme_set(theme_light(base_size = 20, base_family = "Roboto Condensed"))
```

# Inputs

You gotta specify these manually for now.

```{r page_link}
page_url <- "https://www.basketball-reference.com/boxscores/pbp/201912250TOR.html"
```

```{r opponent}
opponent <- "Boston Celtics"
```

# Cleaning 

```{r get_data}
# scrape the url for tables
event_info <- read_html(page_url) %>%
  html_table()

# extract play-by-play table
game_data <- as.data.frame(event_info)[-1,]

# check if toronto is the home team and adjust the column names accordingly
if (str_detect(page_url, "(TOR)") == TRUE){
  names(game_data) <- c("time", "opponent_action", "opponent_point_increase", "running_score", "toronto_point_increase", "toronto_action")
} else {
  names(game_data) <- c("time", "toronto_action", "toronto_point_increase", "running_score", "opponent_point_increase", "opponent_action")
}
```


```{r scoring_plays}
scoring_plays_2 <- game_data %>%
  mutate(toronto_def_rebounds = ifelse(str_detect(toronto_action, "(Defensive rebound)"),
                                       str_extract(toronto_action, "[A-Z]\\. [A-Za-z-]+"),
                                       NA_character_),
         opponent_def_rebounds = ifelse(str_detect(opponent_action, "(Defensive rebound)"),
                                        str_extract(opponent_action, "[A-Z]\\. [A-Za-z-]+"),
                                        NA_character_),
         toronto_action = ifelse(!str_detect(toronto_action, "[a-z]"),
                                 NA,
                                 toronto_action),
         opponent_action = ifelse(!str_detect(opponent_action, "[a-z]"),
                                  NA,
                                  opponent_action),
         player_action = ifelse(is.na(toronto_action),
                                str_extract(opponent_action, "[A-Z]\\. [A-Za-z-]+"),
                                str_extract(toronto_action, "[A-Z]\\. [A-Za-z-]+")),
         team = ifelse(str_detect(toronto_action, "[a-z]"), "Toronto Raptors", opponent)) %>%
  filter(!is.na(player_action)) %>%
  mutate(result = case_when(
    # str_detect(opponent_action, "(Defensive rebound)") | str_detect(toronto_action, "(Defensive rebound)") ~ "Defensive Rebound",
    # str_detect(opponent_action, "(Offensive rebound)") | str_detect(toronto_action, "(Offensive rebound)") ~ "Offensive Rebound",
    # str_detect(opponent_action, "(Turnover)") | str_detect(toronto_action, "(Turnover)") ~ "Turnover",
    str_detect(toronto_action, "(misses)") ~ "Miss",
    str_detect(toronto_point_increase, "[0-9]") | str_detect(opponent_point_increase, "[0-9]") ~ "Score"
    )) %>%
  filter(!is.na(result)) %>%
  mutate(action_order = row_number())


scoring_df <- scoring_plays_2 %>%
  filter(result == "Score") %>%
  group_by(player_action) %>%
  mutate(baskets = row_number())

x_axis <- scoring_plays_2 %>%
  filter(team == "Toronto Raptors") %>%
  distinct(player_action)

data_df <- scoring_plays_2 %>%
  left_join(scoring_df) %>%
  select(player_action, team, result, time, action_order, baskets, running_score) %>%
  mutate(toronto_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$"))),
         away_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+") )),
         running_score = str_glue("{toronto_score}-{away_score}"),
         running_score = paste0(running_score, "\n", time))

data_df <- data_df %>%
         mutate(running_score = factor(running_score,
                                levels = unique(data_df$running_score),
                                ordered = TRUE))

test_plot <- data_df %>%
ggplot(aes(x = player_action, y = baskets, group = action_order)) +
  annotation_custom(raptors_logo,
                    xmin = -Inf, xmax = Inf,
                    ymin = -Inf, ymax = Inf)+
  # geom_text(data = data_df %>% filter(result == "Turnover" & is.na(team)),
  #           aes(label = "STEAL", x = 7, y = 15), size = 10) +
  geom_image(aes(image = "~/Downloads/basketball.png"), size = 0.06) +
   geom_text(data = data_df %>% filter(result == "Miss" & team == "Toronto Raptors"),
            aes(label = "*MISS*", x = 2, y = 15), size = 10) +
  scale_x_discrete("",
                   limits = x_axis$player_action,
                   labels = str_wrap(x_axis$player_action, 2)) +
  scale_y_continuous("Baskets",
                     breaks = seq(0, 25, by = 5)) +
  labs(title = paste0("<b style='color:#BA0C2F'>Toronto Raptors</b> vs. <b style='color:#002B5C'>", opponent, "</b>"),
       subtitle = "{closest_state}") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_markdown(size = 45, face = "bold", colour = "#000000",
                                      lineheight = 1, vjust = -1, hjust = 0.56),
        plot.subtitle = element_text(hjust = 0.5))

anim_2 <- test_plot +
  transition_states(running_score, transition_length = 0.5, state_length = 0.2) +
  enter_fly(y_loc = max(animation_df$player_baskets) + 2) +
  ease_aes(y = "bounce-out") +
  shadow_mark(colour = "white")
```

```{r}

anim_save(anim_2,
          filename = str_glue("animations/raptors_2.gif"),
          width = 1024, height = 512,
          fps = 20,
          duration = 40,
          type = "cairo",
)

beepr::beep()
```

```{r scoring_plays}
# extract only the scoring plays
scoring_plays <- game_data %>%
  mutate(toronto_point_increase = str_extract(toronto_point_increase, "[0-9]"),
         opponent_point_increase = str_extract(opponent_point_increase, "[0-9]")) %>%
  filter(!is.na(toronto_point_increase) | !is.na(opponent_point_increase),
         str_detect(running_score, "[0-9]+-[0-9]+"))
```

```{r player_names}
# extract player name from action data 
scoring_df <- scoring_plays %>%
  mutate(scoring_toronto_player = str_extract(toronto_action, "[A-Z]\\. [A-Za-z-]+"),
         scoring_opponent_player = str_extract(opponent_action, "[A-Z]\\. [A-Za-z-]+"),
         scoring_player = str_remove(paste0(scoring_toronto_player, scoring_opponent_player), "(NA)"),
         scoring_player = str_wrap(scoring_player, 2),
         points = as.numeric(str_extract(paste0(toronto_point_increase, opponent_point_increase), "[0-9]")),
         team = ifelse(str_detect(toronto_action, "[a-z]"), "Toronto Raptors", opponent)) %>%
  select(scoring_player, points, team, running_score) 
```

# Prep for animation

```{r}
# make the game start at 00-00
start_of_game <- data.frame(running_score = "00-00") 

# builds the game's scoring plays and orders them
game_sequence_df <- start_of_game %>%
  bind_rows(scoring_df) %>%
  mutate(action_order = row_number()) %>% # frames for the animation
  group_by(team, scoring_player) %>%
  mutate(player_baskets = row_number()) %>% # player basket counts
  ungroup() 
```

```{r}
# depending on home or away, extract raptor's score and display on the left side of title
if (str_detect(page_url, "(TOR)") == TRUE){
  final_game_sequence_df <- game_sequence_df %>%  
    mutate(toronto_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$"))),
           away_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+") )),
           running_score = str_glue("{toronto_score}-{away_score}"))
} else {
  final_game_sequence_df <- game_sequence_df %>%  
    mutate(toronto_score = sprintf("%02d", as.numeric(str_extract(running_score, "^[0-9]+") )),
           away_score = sprintf("%02d", as.numeric(str_extract(running_score, "[0-9]+$") )),
           running_score = str_glue("{toronto_score}-{away_score}"))
}
```

```{r}
# gotta turn this into a factor so I can use {current_frame} to track boxscore
animation_df <- final_game_sequence_df %>%
  mutate(running_score = factor(running_score, 
                                levels = .$running_score,
                                ordered = TRUE))
```

```{r raptors_logo}
# read the raptors image and make it transparent
l <- readPNG("~/Downloads/toronto_raptors_logo.png")
f <- matrix(rgb(l[,,1],l[,,2],l[,,3], l[,,4] * 0.2), nrow=dim(l)[1]) #0.2 is alpha
raptors_logo <- rasterGrob(f, interpolate=TRUE)
```

```{r plot_breaks}
# raptors players only on the x-axis
x_axis <- animation_df %>% 
  filter(team == "Toronto Raptors") %>% 
  distinct(scoring_player)
```

```{r, warning = FALSE}
base_plot <- animation_df %>%
  ggplot(aes(x = scoring_player, y = player_baskets, group = action_order)) +
  annotation_custom(raptors_logo, 
                    xmin = -Inf, xmax = Inf, 
                    ymin = -Inf, ymax = Inf)+
  geom_image(aes(image = "~/Downloads/basketball.png"), size = 0.06) +
  scale_x_discrete("",
                   limits = x_axis$scoring_player, 
                   labels = str_wrap(x_axis$scoring_player, 2)) +
  scale_y_continuous("Baskets",
                     breaks = seq(0, 25, by = 5)) + 
  labs(title = paste0("<b style='color:#BA0C2F'>Toronto Raptors</b> {closest_state} <b style='color:#007A33'>", opponent, "</b>")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_markdown(size = 45, face = "bold", colour = "#000000",
                                      lineheight = 1, vjust = -1, hjust = 0.56))

# saving this if I want to make 3 pointers look different
# geom_image(data = animation_df %>% filter(points == 3), 
#            aes(image = "~/Downloads/basketball_red.png"), size = 0.06)
```

```{r}
animated_plot <- base_plot +
  transition_states(running_score, transition_length = 0.5, state_length = 0.1, wrap = FALSE) +
  enter_fly(y_loc = max(animation_df$player_baskets) + 2) +
  ease_aes(y = "bounce-out") + 
  shadow_mark()
```

```{r}
anim_save(animated_plot,
          filename = str_glue("animations/raptors_{opponent}-{str_extract(page_url, '[0-9]+')}.gif"), 
          width = 1024, height = 512,
          fps = 25, 
          duration = nrow(animation_df)/3.2, 
          end_pause = 75,
          type = "cairo", 
)

beepr::beep()
```

